<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GS E&C SRU Standardization Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; color: #333; transition: background 0.5s ease; }
        body.simple-mixer { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        body.preheat { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        body.acid-bypass { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        body.acid-bypass-preheat { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        body.fuel-gas { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        body.catalytic { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px; margin-bottom: 40px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); text-align: center; }
        .header h1 { color: #1e3c72; font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .header p { color: #666; font-size: 1.1em; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .composition-section { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .section-title { font-size: 1.5em; color: #1e3c72; margin-bottom: 20px; text-align: center; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; color: #1e3c72; font-weight: 600; margin-bottom: 5px; font-size: 0.95em; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-wrapper input { width: 100%; padding: 12px 45px 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: all 0.3s ease; }
        .input-wrapper input:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .input-unit { position: absolute; right: 15px; color: #666; font-weight: 500; }
        .total-row { margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .total-value { font-size: 1.2em; color: #1e3c72; }
        .validation-message { margin-top: 10px; padding: 10px; border-radius: 5px; text-align: center; font-size: 0.9em; }
        .validation-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .validation-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .config-section { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease; }
        .config-section:hover { transform: translateY(-5px); }
        .recommendation-box { background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center; }
        .recommendation-box h3 { color: #1565c0; margin-bottom: 5px; }
        .recommendation-box p { color: #1976d2; font-weight: 600; font-size: 1.1em; }
        .dropdown-container { position: relative; width: 100%; }
        .dropdown-button { width: 100%; padding: 15px 20px; font-size: 1.1em; background: #1e3c72; color: white; border: none; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; }
        .dropdown-button:hover { background: #2a5298; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(30, 60, 114, 0.3); }
        .dropdown-button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .dropdown-button:disabled:hover { background: #ccc; transform: none; box-shadow: none; }
        .dropdown-arrow { transition: transform 0.3s ease; }
        .dropdown-arrow.open { transform: rotate(180deg); }
        .dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 10px; margin-top: 10px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); overflow: hidden; max-height: 0; transition: max-height 0.3s ease; z-index: 100; }
        .dropdown-menu.open { max-height: 500px; overflow-y: auto; }
        .dropdown-item { padding: 15px 20px; cursor: pointer; transition: all 0.3s ease; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #f5f7fa; padding-left: 30px; }
        .dropdown-item.recommended { background: #e3f2fd; font-weight: bold; } /* Added font-weight */
        .dropdown-item.recommended:hover { background: #bbdefb; }
        .dropdown-item-icon { width: 50px; height: 50px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9em; }
        .icon-simple-mixer { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .icon-preheat { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .icon-acid-bypass { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .icon-acid-bypass-preheat { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .icon-fuel-gas { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .icon-catalytic { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); }
        .dropdown-item-content h4 { color: #1e3c72; margin-bottom: 3px; }
        .dropdown-item-content p { color: #666; font-size: 0.9em; }
        .h2s-percentage { font-weight: bold; color: #1e3c72; }
        .page-content { display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 40px; margin-top: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .back-button { background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; transition: all 0.3s ease; }
        .back-button:hover { background: #555; transform: translateX(-5px); }
        .composition-summary { background: #f5f7fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .composition-summary h3 { color: #1e3c72; margin-bottom: 15px; }
        .composition-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .composition-item { text-align: center; }
        .composition-item .label { color: #666; font-size: 0.9em; }
        .composition-item .value { color: #1e3c72; font-size: 1.3em; font-weight: 600; }
        .equipment-designation-section { background: #f0f4f8; padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #d1d9e6; display: none; }
        .equipment-designation-section h3 { color: #1e3c72; margin-bottom: 20px; text-align: center; font-size: 1.4em; }
        .equipment-dropdown-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .equipment-dropdown-group { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .equipment-dropdown-group label { display: block; font-weight: 600; color: #337ab7; margin-bottom: 8px; font-size: 0.9em; }
        .equipment-dropdown-group select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; background-color: #fff; font-size: 0.95em; cursor: pointer; }
        .equipment-dropdown-group select:focus { border-color: #3498db; box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); outline: none; }
        .equipment-dropdown-group select option.recommended-designation { font-weight: bold; background-color: #e3f2fd; } /* Style for recommended option */
        .sru-drawing-section { background: #f5f7fa; padding: 30px; border-radius: 10px; margin-bottom: 30px; text-align: center; }
        .sru-drawing-title { font-size: 28px; font-weight: bold; color: #1e3c72; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 3px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .sru-drawing-container { background: white; border: 2px solid #ddd; border-radius: 10px; padding: 20px; overflow-x: auto; min-height: 450px; max-height: 700px; }
        .sru-drawing-container svg { display: block; width: 100%; height: auto; }
        .svg-equipment-label { font-size: 11px; fill: #222; text-anchor: middle; font-weight: bold; pointer-events: none; }
        .svg-stream-label { font-size: 10px; fill: #444; text-anchor: middle; pointer-events: none; }
        .tooltip { position: absolute; background-color: rgba(0, 0, 0, 0.95); color: white; padding: 12px 16px; border-radius: 8px; font-size: 14px; pointer-events: none; z-index: 1000; opacity: 0; transition: opacity 0.3s; max-width: 350px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .tooltip.visible { opacity: 1; }
        .tooltip-title { font-weight: bold; color: #4CAF50; margin-bottom: 8px; font-size: 16px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; }
        .tooltip-value { margin: 4px 0; display: flex; justify-content: space-between; align-items: center; }
        .tooltip-label { color: #bbb; margin-right: 10px; }
        .tooltip-data { color: #fff; font-weight: 500; }
        .equipment-hover { cursor: pointer; transition: all 0.3s; }
        .equipment-hover:hover { filter: brightness(1.15) drop-shadow(0 0 8px rgba(0,100,200,0.4)); }
        .stream-hover { cursor: pointer; transition: all 0.3s; }
        .stream-hover:hover { filter: brightness(1.2); stroke-width: 3.5px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .info-card { background: #f5f7fa; padding: 25px; border-radius: 10px; transition: all 0.3s ease; }
        .info-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .info-card h3 { color: #1e3c72; margin-bottom: 15px; }
        .info-card ul { list-style: none; padding: 0; }
        .info-card li { padding: 8px 0; color: #666; display: flex; align-items: center; }
        .info-card li:before { content: "▸"; margin-right: 10px; color: #1e3c72; }
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .main-grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
            .dropdown-item-icon { width: 40px; height: 40px; font-size: 0.8em; }
            .equipment-dropdown-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
             <h1>GS E&C SRU Standardization Platform</h1>
             <p>H2S-Based Configuration Selection System</p>
        </div>

        <div class="main-grid" id="mainGrid">
            <!-- ... Gas Composition and Config Selector (same as before) ... -->
            <div class="composition-section">
                <h2 class="section-title">Acid Gas Composition</h2>
                <div class="input-group"><label for="h2s">H2S</label><div class="input-wrapper"><input type="number" id="h2s" min="0" max="100" step="0.01" placeholder="0.00"><span class="input-unit">mol%</span></div></div>
                <div class="input-group"><label for="co2">CO2</label><div class="input-wrapper"><input type="number" id="co2" min="0" max="100" step="0.01" placeholder="0.00"><span class="input-unit">mol%</span></div></div>
                <div class="input-group"><label for="nh3">NH3</label><div class="input-wrapper"><input type="number" id="nh3" min="0" max="100" step="0.01" placeholder="0.00"><span class="input-unit">mol%</span></div></div>
                <div class="input-group"><label for="btex">BTEX</label><div class="input-wrapper"><input type="number" id="btex" min="0" max="100" step="0.01" placeholder="0.00"><span class="input-unit">mol%</span></div></div>
                <div class="input-group"><label for="other_hc">Other HC</label><div class="input-wrapper"><input type="number" id="other_hc" min="0" max="100" step="0.01" placeholder="0.00"><span class="input-unit">mol%</span></div></div>
                <div class="total-row"><span>Total:</span><span class="total-value" id="totalValue">0.00%</span></div>
                <div id="validationMessage"></div>
            </div>
            <div class="config-section" id="configSection">
                <h2 class="section-title">Select Configuration</h2>
                <div class="recommendation-box" id="recommendationBox" style="display: none;"><h3>Recommended Configuration</h3><p id="recommendedConfig"></p></div>
                <div class="dropdown-container">
                    <button class="dropdown-button" id="dropdownButton" onclick="toggleDropdown()" disabled><span>Enter gas composition first</span><span class="dropdown-arrow" id="dropdownArrow">▼</span></button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <div class="dropdown-item" id="config-simple-mixer" onclick="selectConfig('simple-mixer')"><div class="dropdown-item-icon icon-simple-mixer">>55%</div><div class="dropdown-item-content"><h4>Simple Mixer</h4><p><span class="h2s-percentage">H2S > 55%</span></p></div></div>
                        <div class="dropdown-item" id="config-preheat" onclick="selectConfig('preheat')"><div class="dropdown-item-icon icon-preheat">30-55%</div><div class="dropdown-item-content"><h4>Preheat</h4><p><span class="h2s-percentage">H2S 30-55%</span></p></div></div>
                        <div class="dropdown-item" id="config-acid-bypass" onclick="selectConfig('acid-bypass')"><div class="dropdown-item-icon icon-acid-bypass">15-30%</div><div class="dropdown-item-content"><h4>Acid Gas Bypass</h4><p><span class="h2s-percentage">H2S 15-30%</span></p></div></div>
                        <div class="dropdown-item" id="config-acid-bypass-preheat" onclick="selectConfig('acid-bypass-preheat')"><div class="dropdown-item-icon icon-acid-bypass-preheat">10-15%</div><div class="dropdown-item-content"><h4>Acid Gas Bypass + Preheat</h4><p><span class="h2s-percentage">H2S 10-15%</span></p></div></div>
                        <div class="dropdown-item" id="config-fuel-gas" onclick="selectConfig('fuel-gas')"><div class="dropdown-item-icon icon-fuel-gas">5-10%</div><div class="dropdown-item-content"><h4>Fuel Gas</h4><p><span class="h2s-percentage">H2S 5-10%</span></p></div></div>
                        <div class="dropdown-item" id="config-catalytic" onclick="selectConfig('catalytic')"><div class="dropdown-item-icon icon-catalytic"><5%</div><div class="dropdown-item-content"><h4>Catalytic Oxidation</h4><p><span class="h2s-percentage">H2S < 5%</span></p></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-content" id="pageContent">
            <button class="back-button" onclick="goBack()">← Back to Configuration Selection</button>
            <div class="composition-summary"><h3>Gas Composition Summary</h3><div class="composition-grid" id="compositionGrid"></div></div>

            <div class="equipment-designation-section" id="equipmentDesignationSection">
                <h3>Equipment Designation</h3>
                <div class="equipment-dropdown-grid">
                    <div class="equipment-dropdown-group">
                        <label for="select-page-feed-d44-1-designation">Feed Stream D44-1</label>
                        <select id="select-page-feed-d44-1-designation" data-equipment-id="page-feed-d44-1">
                            <option value="">Select...</option><option value="AG-SWS">AG-SWS</option><option value="FEED-AUX1">FEED-AUX1</option><option value="D44-1-ALT1">D44-1-ALT1</option><option value="D44-1-ALT2">D44-1-ALT2</option>
                        </select>
                    </div>
                    <div class="equipment-dropdown-group">
                        <label for="select-page-feed-d44-2-designation">Acid Gas (Amine Reg.) D44-2</label>
                        <select id="select-page-feed-d44-2-designation" data-equipment-id="page-feed-d44-2">
                            <option value="">Select...</option><option value="AG-MAIN">AG-MAIN</option><option value="FEED-ARU1">FEED-ARU1</option><option value="D44-2-SYS-A">D44-2-SYS-A</option><option value="D44-2-SYS-B">D44-2-SYS-B</option>
                        </select>
                    </div>
                    <div class="equipment-dropdown-group">
                        <label for="select-page-feed-d44-3-designation">Combustion Air D44-3</label>
                        <select id="select-page-feed-d44-3-designation" data-equipment-id="page-feed-d44-3">
                            <option value="">Select...</option><option value="AIR-COMB">AIR-COMB</option><option value="AIR-MAB1">AIR-MAB1</option><option value="AIR-BLOWER-01">AIR-BLOWER-01</option><option value="AIR-BLOWER-02">AIR-BLOWER-02</option>
                        </select>
                    </div>
                    <div class="equipment-dropdown-group">
                        <label for="select-page-thermal-reactor-designation">Thermal Reactor</label>
                        <select id="select-page-thermal-reactor-designation" data-equipment-id="page-thermal-reactor">
                            <option value="">Select...</option><option value="RF-101A">RF-101A</option><option value="RF-101B">RF-101B</option><option value="F-201">F-201</option><option value="F-202">F-202</option>
                        </select>
                    </div>
                    <div class="equipment-dropdown-group">
                        <label for="select-page-condenser-1-designation">1st Sulphur Condenser</label>
                        <select id="select-page-condenser-1-designation" data-equipment-id="page-condenser-1">
                            <option value="">Select...</option><option value="SC-102A">SC-102A (WHB)</option><option value="SC-102B">SC-102B (Cooler)</option><option value="E-202A">E-202A</option><option value="E-202B">E-202B</option>
                        </select>
                    </div>
                    <div class="equipment-dropdown-group">
                        <label for="select-page-condenser-2-designation">2nd Sulphur Condenser</label>
                        <select id="select-page-condenser-2-designation" data-equipment-id="page-condenser-2">
                             <option value="">Select...</option><option value="SC-103A">SC-103A</option><option value="SC-103B">SC-103B</option><option value="E-203A">E-203A</option><option value="E-203B">E-203B</option>
                        </select>
                    </div>
                     <div class="equipment-dropdown-group">
                        <label for="select-page-condenser-3-designation">3rd Sulphur Condenser</label>
                        <select id="select-page-condenser-3-designation" data-equipment-id="page-condenser-3">
                             <option value="">Select...</option><option value="SC-104A">SC-104A</option><option value="SC-104B">SC-104B</option><option value="E-204A">E-204A</option><option value="E-204B">E-204B</option>
                        </select>
                    </div>
                    <div class="equipment-dropdown-group">
                        <label for="select-page-reheater-cat1-designation">Reheater (Catalytic Stage 1)</label>
                        <select id="select-page-reheater-cat1-designation" data-equipment-id="page-reheater-cat1">
                            <option value="">Select...</option><option value="RH-105A">RH-105A</option><option value="RH-105B">RH-105B</option><option value="HX-205A">HX-205A</option><option value="HX-205B">HX-205B</option>
                        </select>
                    </div>
                    <div class="equipment-dropdown-group">
                        <label for="select-page-cat-converter-1-designation">1st Catalytic Converter</label>
                        <select id="select-page-cat-converter-1-designation" data-equipment-id="page-cat-converter-1">
                            <option value="">Select...</option><option value="CR-106A">CR-106A</option><option value="CR-106B">CR-106B</option><option value="R-206A">R-206A</option><option value="R-206B">R-206B</option>
                        </select>
                    </div>
                    <div class="equipment-dropdown-group">
                        <label for="select-page-sulphur-seal-1-designation">Sulphur Seal/Cooler 1</label>
                        <select id="select-page-sulphur-seal-1-designation" data-equipment-id="page-sulphur-seal-1">
                            <option value="">Select...</option><option value="SS-107A">SS-107A</option><option value="CL-107A">CL-107A</option><option value="SCS-207A">SCS-207A</option><option value="SCS-207B">SCS-207B</option>
                        </select>
                    </div>
                    <div class="equipment-dropdown-group">
                        <label for="select-page-cat-converter-2-designation">2nd Catalytic Converter</label>
                        <select id="select-page-cat-converter-2-designation" data-equipment-id="page-cat-converter-2">
                             <option value="">Select...</option><option value="CR-108A">CR-108A</option><option value="CR-108B">CR-108B</option><option value="R-208A">R-208A</option><option value="R-208B">R-208B</option>
                        </select>
                    </div>
                     <div class="equipment-dropdown-group">
                        <label for="select-page-sulphur-seal-2-designation">Sulphur Seal/Cooler 2</label>
                        <select id="select-page-sulphur-seal-2-designation" data-equipment-id="page-sulphur-seal-2">
                            <option value="">Select...</option><option value="SS-109A">SS-109A</option><option value="CL-109A">CL-109A</option><option value="SCS-209A">SCS-209A</option><option value="SCS-209B">SCS-209B</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="sru-drawing-section">
                <div class="sru-drawing-title">SRU DRAWING</div>
                <div class="sru-drawing-container" id="sruDrawingContainer">
                    <!-- SVG will be inserted here by JS -->
                </div>
            </div>

            <h2 id="pageTitle"></h2>
            <p id="pageDescription"></p>
            <div class="info-grid" id="infoGrid"></div>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        let gasComposition = { h2s: 0, co2: 0, nh3: 0, btex: 0, other_hc: 0 };
        let selectedDesignations = {};

        const sruDrawings = {
            'simple-mixer': `
                <svg id="interactive-sru-diagram-page" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <marker id="arrowhead-feed" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto" fill="#0056b3"><polygon points="0 0, 10 3.5, 0 7"/></marker>
                        <marker id="arrowhead-process" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto" fill="#555"><polygon points="0 0, 10 3.5, 0 7"/></marker>
                        <marker id="arrowhead-sulphur" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto" fill="#DAA520"><polygon points="0 0, 8 3, 0 6"/></marker>
                         <marker id="arrowhead-hotgas" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto" fill="#E53935"><polygon points="0 0, 10 3.5, 0 7"/></marker>
                        <filter id="shadow-filter" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="2" dy="3" stdDeviation="2" flood-color="#000" flood-opacity="0.15"/></filter>
                         <pattern id="hatch" patternUnits="userSpaceOnUse" width="8" height="8"><path d="M-2,2 l4,-4 M0,8 l8,-8 M6,10 l4,-4" stroke="#4CAF50" stroke-width="1"/></pattern>
                    </defs>
                    <g id="page-overall-flow-arrow"><line x1="30" y1="50" x2="100" y2="50" stroke="#0056b3" stroke-width="15" marker-end="url(#arrowhead-feed)"/><text x="65" y="40" class="svg-stream-label" fill="#0056b3">Main Flow</text></g>
                    <g id="page-feed-d44-1" transform="translate(50, 120)" class="equipment-hover" filter="url(#shadow-filter)"><path d="M0,0 L50,0 L70,20 L50,40 L0,40 L20,20 Z" fill="#B3E5FC" stroke="#0277BD" stroke-width="1.5"/><text x="35" y="25" class="svg-equipment-label" fill="#01579B">D44-1</text></g>
                    <g id="page-feed-d44-2" transform="translate(50, 200)" class="equipment-hover" filter="url(#shadow-filter)"><path d="M0,0 L50,0 L70,20 L50,40 L0,40 L20,20 Z" fill="#B3E5FC" stroke="#0277BD" stroke-width="1.5"/><text x="35" y="18" class="svg-equipment-label" fill="#01579B">D44-2</text><text x="35" y="32" class="svg-stream-label" font-size="9" fill="#01579B">Acid Gas (Amine)</text></g>
                    <g id="page-feed-d44-3" transform="translate(50, 280)" class="equipment-hover" filter="url(#shadow-filter)"><path d="M0,0 L50,0 L70,20 L50,40 L0,40 L20,20 Z" fill="#B3E5FC" stroke="#0277BD" stroke-width="1.5"/><text x="35" y="18" class="svg-equipment-label" fill="#01579B">D44-3</text><text x="35" y="32" class="svg-stream-label" font-size="9" fill="#01579B">Comb. Air</text></g>
                    <g id="page-thermal-reactor" transform="translate(180, 180)" class="equipment-hover" filter="url(#shadow-filter)"><rect x="0" y="0" width="120" height="100" fill="#FFCDD2" stroke="#C62828" stroke-width="2" rx="5"/><rect x="-30" y="20" width="30" height="60" fill="#EF9A9A" stroke="#C62828" stroke-width="1.5" rx="3"/><rect x="20" y="15" width="80" height="20" fill="#EF9A9A" stroke="#C62828" stroke-width="1.5" rx="3"/><text x="60" y="55" class="svg-equipment-label" fill="#B71C1C">Thermal Reactor</text></g>
                    <g id="page-condenser-1" transform="translate(330, 180)" class="equipment-hover" filter="url(#shadow-filter)"><rect x="0" y="0" width="130" height="100" fill="#C5CAE9" stroke="#303F9F" stroke-width="2" rx="5"/><rect x="90" y="10" width="30" height="80" fill="url(#hatch)" stroke="#303F9F" stroke-width="1"/><line x1="85" y1="5" x2="85" y2="95" stroke="#303F9F" stroke-width="1.5"/><text x="45" y="55" class="svg-equipment-label" fill="#1A237E">1st Condenser</text></g>
                    <g id="page-condenser-2" transform="translate(490, 180)" class="equipment-hover" filter="url(#shadow-filter)"><rect x="0" y="0" width="130" height="100" fill="#C5CAE9" stroke="#303F9F" stroke-width="2" rx="5"/><rect x="90" y="10" width="30" height="80" fill="url(#hatch)" stroke="#303F9F" stroke-width="1"/><line x1="85" y1="5" x2="85" y2="95" stroke="#303F9F" stroke-width="1.5"/><text x="45" y="55" class="svg-equipment-label" fill="#1A237E">2nd Condenser</text></g>
                    <g id="page-condenser-3" transform="translate(650, 180)" class="equipment-hover" filter="url(#shadow-filter)"><rect x="0" y="0" width="130" height="100" fill="#C5CAE9" stroke="#303F9F" stroke-width="2" rx="5"/><rect x="90" y="10" width="30" height="80" fill="url(#hatch)" stroke="#303F9F" stroke-width="1"/><line x1="85" y1="5" x2="85" y2="95" stroke="#303F9F" stroke-width="1.5"/><text x="45" y="55" class="svg-equipment-label" fill="#1A237E">3rd Condenser</text></g>
                    <g id="page-reheater-cat1" transform="translate(400, 30)" class="equipment-hover" filter="url(#shadow-filter)"><ellipse cx="30" cy="15" rx="30" ry="15" fill="#A5D6A7" stroke="#2E7D32" stroke-width="1.5"/><rect x="0" y="15" width="60" height="70" fill="#A5D6A7" stroke="#2E7D32" stroke-width="1.5"/><ellipse cx="30" cy="85" rx="30" ry="15" fill="#A5D6A7" stroke="#2E7D32" stroke-width="1.5"/><text x="30" y="55" class="svg-equipment-label" fill="#1B5E20">Reheater</text></g>
                    <g id="page-cat-converter-1" transform="translate(500, 30)" class="equipment-hover" filter="url(#shadow-filter)"><ellipse cx="60" cy="15" rx="60" ry="15" fill="#81C784" stroke="#2E7D32" stroke-width="2"/><rect x="0" y="15" width="120" height="70" fill="#81C784" stroke="#2E7D32" stroke-width="2"/><ellipse cx="60" cy="85" rx="60" ry="15" fill="#81C784" stroke="#2E7D32" stroke-width="2"/><line x1="15" y1="25" x2="105" y2="75" stroke="#1B5E20" stroke-width="2"/><line x1="105" y1="25" x2="15" y2="75" stroke="#1B5E20" stroke-width="2"/><text x="60" y="55" class="svg-equipment-label" fill="#1B5E20">1st Converter</text></g>
                    <g id="page-sulphur-seal-1" transform="translate(660, 40)" class="equipment-hover" filter="url(#shadow-filter)"><circle cx="25" cy="25" r="25" fill="#FFECB3" stroke="#FFA000" stroke-width="2"/><path d="M5,5 L15,15 M15,5 L5,15" stroke="red" stroke-width="2.5" marker-start="url(#arrowhead-hotgas)" marker-end="url(#arrowhead-hotgas)"/><text x="25" y="60" class="svg-equipment-label" fill="#E65100">Seal 1</text></g>
                    <g id="page-cat-converter-2" transform="translate(750, 30)" class="equipment-hover" filter="url(#shadow-filter)"><ellipse cx="60" cy="15" rx="60" ry="15" fill="#81C784" stroke="#2E7D32" stroke-width="2"/><rect x="0" y="15" width="120" height="70" fill="#81C784" stroke="#2E7D32" stroke-width="2"/><ellipse cx="60" cy="85" rx="60" ry="15" fill="#81C784" stroke="#2E7D32" stroke-width="2"/><line x1="15" y1="25" x2="105" y2="75" stroke="#1B5E20" stroke-width="2"/><line x1="105" y1="25" x2="15" y2="75" stroke="#1B5E20" stroke-width="2"/><text x="60" y="55" class="svg-equipment-label" fill="#1B5E20">2nd Converter</text></g>
                    <g id="page-sulphur-seal-2" transform="translate(910, 40)" class="equipment-hover" filter="url(#shadow-filter)"><circle cx="25" cy="25" r="25" fill="#FFECB3" stroke="#FFA000" stroke-width="2"/><path d="M5,5 L15,15 M15,5 L5,15" stroke="red" stroke-width="2.5" marker-start="url(#arrowhead-hotgas)" marker-end="url(#arrowhead-hotgas)"/><text x="25" y="60" class="svg-equipment-label" fill="#E65100">Seal 2</text></g>
                    <line x1="120" y1="140" x2="165" y2="210" stroke="#0288D1" stroke-width="2.5" marker-end="url(#arrowhead-feed)" class="stream-hover" data-stream="page-feed-d44-1-stream"/>
                    <line x1="120" y1="220" x2="150" y2="230" stroke="#0288D1" stroke-width="2.5" marker-end="url(#arrowhead-feed)" class="stream-hover" data-stream="page-feed-d44-2-stream"/>
                    <line x1="120" y1="300" x2="165" y2="250" stroke="#0288D1" stroke-width="2.5" marker-end="url(#arrowhead-feed)" class="stream-hover" data-stream="page-feed-d44-3-stream"/>
                    <line x1="300" y1="230" x2="330" y2="230" stroke="#AD1457" stroke-width="3" marker-end="url(#arrowhead-hotgas)" class="stream-hover" data-stream="tr-to-cond1-stream"/><text x="315" y="220" class="svg-stream-label" fill="#AD1457">Hot Gas</text>
                    <line x1="460" y1="230" x2="490" y2="230" stroke="#546E7A" stroke-width="2.5" marker-end="url(#arrowhead-process)" class="stream-hover" data-stream="cond1-to-cond2-stream"/>
                    <line x1="620" y1="230" x2="650" y2="230" stroke="#546E7A" stroke-width="2.5" marker-end="url(#arrowhead-process)" class="stream-hover" data-stream="cond2-to-cond3-stream"/>
                    <line x1="395" y1="280" x2="395" y2="350" stroke="#DAA520" stroke-width="2" marker-end="url(#arrowhead-sulphur)" class="stream-hover" data-stream="sulphur-cond1-stream"/><text x="395" y="330" class="svg-stream-label" fill="#B8860B">S</text>
                    <line x1="555" y1="280" x2="555" y2="350" stroke="#DAA520" stroke-width="2" marker-end="url(#arrowhead-sulphur)" class="stream-hover" data-stream="sulphur-cond2-stream"/><text x="555" y="330" class="svg-stream-label" fill="#B8860B">S</text>
                    <line x1="715" y1="280" x2="715" y2="350" stroke="#DAA520" stroke-width="2" marker-end="url(#arrowhead-sulphur)" class="stream-hover" data-stream="sulphur-cond3-stream"/><text x="715" y="330" class="svg-stream-label" fill="#B8860B">S</text>
                    <line x1="395" y1="350" x2="715" y2="350" stroke="#DAA520" stroke-width="2" class="stream-hover" data-stream="sulphur-mainline-cond-stream"/>
                    <line x1="555" y1="350" x2="555" y2="380" stroke="#DAA520" stroke-width="2" marker-end="url(#arrowhead-sulphur)" class="stream-hover" data-stream="sulphur-to-pit-cond-stream"/><text x="555" y="400" class="svg-stream-label" fill="#B8860B">To Sulphur Pit</text>
                    <path d="M460 210 Q470 150 430 100 L430 85" stroke="#546E7A" stroke-width="2.5" fill="none" marker-end="url(#arrowhead-process)" class="stream-hover" data-stream="procgas-to-reheater-stream"/><text x="450" y="130" class="svg-stream-label">To Reheater</text>
                    <line x1="460" y1="60" x2="500" y2="60" stroke="#546E7A" stroke-width="2.5" marker-end="url(#arrowhead-process)" class="stream-hover" data-stream="reheater-to-cat1-stream"/>
                    <line x1="620" y1="60" x2="660" y2="60" stroke="#546E7A" stroke-width="2.5" marker-end="url(#arrowhead-process)" class="stream-hover" data-stream="cat1-to-seal1-stream"/>
                    <line x1="710" y1="60" x2="750" y2="60" stroke="#546E7A" stroke-width="2.5" marker-end="url(#arrowhead-process)" class="stream-hover" data-stream="seal1-to-cat2-stream"/>
                    <line x1="870" y1="60" x2="910" y2="60" stroke="#546E7A" stroke-width="2.5" marker-end="url(#arrowhead-process)" class="stream-hover" data-stream="cat2-to-seal2-stream"/>
                    <line x1="960" y1="60" x2="1000" y2="60" stroke="#546E7A" stroke-width="2.5" marker-end="url(#arrowhead-process)" class="stream-hover" data-stream="tailgas-stream"/><text x="1030" y="65" class="svg-stream-label">Tail Gas</text>
                    <line x1="685" y1="90" x2="685" y2="120" stroke="#DAA520" stroke-width="2" marker-end="url(#arrowhead-sulphur)" class="stream-hover" data-stream="sulphur-seal1-stream"/><text x="685" y="110" class="svg-stream-label" fill="#B8860B">S</text>
                    <line x1="935" y1="90" x2="935" y2="120" stroke="#DAA520" stroke-width="2" marker-end="url(#arrowhead-sulphur)" class="stream-hover" data-stream="sulphur-seal2-stream"/><text x="935" y="110" class="svg-stream-label" fill="#B8860B">S</text>
                    <line x1="685" y1="120" x2="935" y2="120" stroke="#DAA520" stroke-width="2" class="stream-hover" data-stream="sulphur-mainline-seal-stream"/>
                    <line x1="810" y1="120" x2="810" y2="150" stroke="#DAA520" stroke-width="2" marker-end="url(#arrowhead-sulphur)" class="stream-hover" data-stream="sulphur-to-pit-seal-stream"/><text x="810" y="170" class="svg-stream-label" fill="#B8860B">To Sulphur Pit</text>
                    <rect x="0" y="0" width="1200" height="700" fill="none" stroke="#ccc" stroke-width="1" stroke-dasharray="5,5"/>
                </svg>
            `,
            'preheat': `<svg id="interactive-sru-diagram-page" viewBox="0 0 300 100"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Preheat Drawing Placeholder</text></svg>`,
            'acid-bypass': `<svg id="interactive-sru-diagram-page" viewBox="0 0 300 100"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Acid Bypass Drawing Placeholder</text></svg>`,
            'acid-bypass-preheat': `<svg id="interactive-sru-diagram-page" viewBox="0 0 300 100"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Acid Bypass + Preheat Drawing</text></svg>`,
            'fuel-gas': `<svg id="interactive-sru-diagram-page" viewBox="0 0 300 100"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Fuel Gas Drawing Placeholder</text></svg>`,
            'catalytic': `<svg id="interactive-sru-diagram-page" viewBox="0 0 300 100"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Catalytic Oxidation Drawing</text></svg>`
        };
        const detailedDrawingActual = sruDrawings['simple-mixer'];
        for (const key in sruDrawings) {
            if (sruDrawings[key].includes("Placeholder")) {
                sruDrawings[key] = detailedDrawingActual;
            }
        }


        const equipmentData = {
            "page-feed-d44-1": { name:"Feed D44-1", type:"Auxiliary Acid Gas", pressure:"0.4 barg", temp:"Ambient"},
            "page-feed-d44-2": { name:"Feed D44-2", type:"Main Acid Gas (Amine)", pressure:"0.5 barg", temp:"60°C"},
            "page-feed-d44-3": { name:"Feed D44-3", type:"Combustion Air", pressure:"0.6 barg", temp:"Ambient"},
            "page-thermal-reactor": { name:"Thermal Reactor", temp_op:"1250-1400°C", residence_t:"0.8-1.2s", purpose:"H2S Oxidation"},
            "page-condenser-1": { name:"1st Sulphur Condenser", inlet_t:"~650°C", outlet_t:"170-190°C", medium:"HP/MP Steam"},
            "page-condenser-2": { name:"2nd Sulphur Condenser", inlet_t:"~240°C", outlet_t:"150-170°C", medium:"LP Steam"},
            "page-condenser-3": { name:"3rd Sulphur Condenser", inlet_t:"~220°C", outlet_t:"135-150°C", medium:"BFW Preheating"},
            "page-reheater-cat1": { name:"Reheater (Cat. Stg 1)", inlet_t:"150-170°C", outlet_t:"220-240°C", medium:"HP Steam"},
            "page-cat-converter-1": { name:"1st Catalytic Converter", inlet_t:"220-240°C", outlet_t:"~300°C", catalyst:"Alumina"},
            "page-sulphur-seal-1": { name:"Sulphur Seal/Cooler 1", purpose:"Collect & Cool S", temp_out:"~140°C"},
            "page-cat-converter-2": { name:"2nd Catalytic Converter", inlet_t:"~210°C", outlet_t:"~250°C", catalyst:"Titania"},
            "page-sulphur-seal-2": { name:"Sulphur Seal/Cooler 2", purpose:"Collect & Cool S", temp_out:"~140°C"},
        };
        const streamData = {
            "page-feed-d44-1-stream": {name: "D44-1 Stream", flow: "50 kmol/hr", comp: "H2S: 20%"},
            "page-feed-d44-2-stream": {name: "D44-2 Stream", flow: "500 kmol/hr", comp: "H2S: 70%"},
            "page-feed-d44-3-stream": {name: "D44-3 Stream", flow: "As per Stoich."},
            "tr-to-cond1-stream": {name: "TR Outlet", temp: "650°C"},
            "cond1-to-cond2-stream": {name: "Cond 1 Outlet", temp: "180°C"},
            "cond2-to-cond3-stream": {name: "Cond 2 Outlet", temp: "160°C"},
            "sulphur-cond1-stream": {name: "S from Cond 1"}, "sulphur-cond2-stream": {name: "S from Cond 2"}, "sulphur-cond3-stream": {name: "S from Cond 3"},
            "sulphur-mainline-cond-stream": {name: "Main S (Cond)"}, "sulphur-to-pit-cond-stream": {name: "S to Pit (Cond)"},
            "procgas-to-reheater-stream": {name: "Gas to Reheater"}, "reheater-to-cat1-stream": {name: "Gas to Cat 1"},
            "cat1-to-seal1-stream": {name: "Cat 1 Outlet"}, "seal1-to-cat2-stream": {name: "Gas to Cat 2"},
            "cat2-to-seal2-stream": {name: "Cat 2 Outlet"}, "tailgas-stream": {name: "Tail Gas"},
            "sulphur-seal1-stream": {name: "S from Seal 1"}, "sulphur-seal2-stream": {name: "S from Seal 2"},
            "sulphur-mainline-seal-stream": {name: "Main S (Seals)"}, "sulphur-to-pit-seal-stream": {name: "S to Pit (Seals)"},
        };

        window.updateTotal = function() { /* ... Same as before ... */ 
            const h2sInput = parseFloat(document.getElementById('h2s').value) || 0;
            const co2Input = parseFloat(document.getElementById('co2').value) || 0;
            const nh3Input = parseFloat(document.getElementById('nh3').value) || 0;
            const btexInput = parseFloat(document.getElementById('btex').value) || 0;
            const other_hcInput = parseFloat(document.getElementById('other_hc').value) || 0;
            gasComposition = { h2s: h2sInput, co2: co2Input, nh3: nh3Input, btex: btexInput, other_hc: other_hcInput };
            const total = h2sInput + co2Input + nh3Input + btexInput + other_hcInput;
            document.getElementById('totalValue').textContent = total.toFixed(2) + '%';
            const validationMessage = document.getElementById('validationMessage');
            const dropdownButton = document.getElementById('dropdownButton');
            const recommendationBox = document.getElementById('recommendationBox');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const roundedTotal = parseFloat(total.toFixed(2));
            const allInputsZero = h2sInput === 0 && co2Input === 0 && nh3Input === 0 && btexInput === 0 && other_hcInput === 0;

            if (allInputsZero) {
                validationMessage.innerHTML = '';
                dropdownButton.disabled = true;
                dropdownButton.innerHTML = '<span>Enter gas composition first</span><span class="dropdown-arrow" id="dropdownArrow">▼</span>';
                recommendationBox.style.display = 'none';
                if (dropdownMenu.classList.contains('open')) toggleDropdown();
            } else if (roundedTotal === 100.00) {
                validationMessage.innerHTML = '<div class="validation-success">✓ Composition is valid (100%)</div>';
                dropdownButton.disabled = false;
                dropdownButton.innerHTML = '<span>Choose H2S Configuration</span><span class="dropdown-arrow" id="dropdownArrow">▼</span>';
                updateRecommendation(h2sInput);
            } else {
                validationMessage.innerHTML = `<div class="validation-error">✗ Total must equal 100% (currently ${total.toFixed(2)}%)</div>`;
                dropdownButton.disabled = true;
                dropdownButton.innerHTML = '<span>Complete composition to 100%</span><span class="dropdown-arrow" id="dropdownArrow">▼</span>';
                recommendationBox.style.display = 'none';
                if (dropdownMenu.classList.contains('open')) toggleDropdown();
            }
        };
        
        const configurations = {
            'simple-mixer': { title: 'Simple Mixer Configuration', description: 'Optimized for H2S > 55%', colorClass: 'simple-mixer', 
                info: [{title: 'Process Parameters', items: ['Direct mixing','Minimal preheat']},{title: 'Equipment', items: ['Std. burner']}],
                recommendedDesignations: { 'page-thermal-reactor': 'RF-101B', 'page-condenser-1': 'SC-102A', 'page-reheater-cat1': 'RH-105A', /* ... add all ... */ }
            },
            'preheat': { title: 'Preheat Configuration', description: 'For H2S 30-55%', colorClass: 'preheat', 
                info: [{title: 'Process', items: ['AG preheat']},{title: 'Equipment', items: ['Preheat Exchanger']}],
                recommendedDesignations: { 'page-thermal-reactor': 'RF-101A', 'page-condenser-1': 'SC-102B', 'page-reheater-cat1': 'RH-105B', /* ... add all ... */ }
            },
            'acid-bypass': { title: 'Acid Gas Bypass', description: 'For H2S 15-30%', colorClass: 'acid-bypass', 
                info: [{title: 'Process', items: ['Partial AG bypass']},{title: 'Equipment', items: ['Bypass valves']}],
                recommendedDesignations: { 'page-thermal-reactor': 'F-201', 'page-condenser-1': 'E-202A', 'page-reheater-cat1': 'HX-205A', /* ... add all ... */ }
            },
            'acid-bypass-preheat': { title: 'Acid Gas Bypass + Preheat', description: 'For H2S 10-15%', colorClass: 'acid-bypass-preheat', 
                info: [{title: 'Process', items: ['Combined bypass & preheat']},{title: 'Equipment', items: ['Dual controls']}],
                recommendedDesignations: { 'page-thermal-reactor': 'F-202', 'page-condenser-1': 'E-202B', 'page-reheater-cat1': 'HX-205B', /* ... add all ... */ }
            },
            'fuel-gas': { title: 'Fuel Gas Configuration', description: 'For H2S 5-10%', colorClass: 'fuel-gas', 
                info: [{title: 'Process', items: ['Supplemental fuel']},{title: 'Equipment', items: ['Fuel gas system']}],
                recommendedDesignations: { 'page-thermal-reactor': 'RF-101A', 'page-condenser-1': 'SC-102A', 'page-condenser-2': 'SC-103B', /* ... add all ... */ }
            },
            'catalytic': { title: 'Catalytic H2S Oxidation', description: 'For H2S < 5%', colorClass: 'catalytic', 
                info: [{title: 'Process', items: ['Catalytic conversion']},{title: 'Equipment', items: ['Catalyst reactors']}],
                recommendedDesignations: { 'page-thermal-reactor': 'RF-101B', 'page-condenser-1': 'SC-102A', 'page-cat-converter-1': 'CR-106A', /* ... add all ... */ }
            }
        };
        // Fill in recommended designations for all equipment for each config type
        const allEquipmentIds = Object.keys(equipmentData); // Assuming equipmentData keys match SVG IDs
        for (const configKey in configurations) {
            if (!configurations[configKey].recommendedDesignations) {
                configurations[configKey].recommendedDesignations = {};
            }
            allEquipmentIds.forEach((eqId, index) => {
                if (!configurations[configKey].recommendedDesignations[eqId]) {
                    const selectElement = document.getElementById(`select-${eqId}-designation`);
                    if (selectElement && selectElement.options.length > 1) {
                        // Cycle through options for variety, or pick a fixed one like the second option
                        const recommendedOptionIndex = (Object.keys(configurations).indexOf(configKey) + index) % (selectElement.options.length -1) + 1;
                         configurations[configKey].recommendedDesignations[eqId] = selectElement.options[recommendedOptionIndex]?.value || selectElement.options[1]?.value || "";
                    } else {
                        configurations[configKey].recommendedDesignations[eqId] = ""; // Default if no options
                    }
                }
            });
        }


        function updateRecommendation(h2s) { /* ... Same as before ... */ 
            const box = document.getElementById('recommendationBox');
            const textEl = document.getElementById('recommendedConfig');
            box.style.display = 'block';
            document.querySelectorAll('.dropdown-item').forEach(item => item.classList.remove('recommended'));
            let key = '', text = '';
            if (h2s > 55) { text = 'Simple Mixer'; key = 'simple-mixer'; }
            else if (h2s >= 30) { text = 'Preheat'; key = 'preheat'; }
            else if (h2s >= 15) { text = 'Acid Gas Bypass'; key = 'acid-bypass'; }
            else if (h2s >= 10) { text = 'Acid Gas Bypass + Preheat'; key = 'acid-bypass-preheat'; }
            else if (h2s >= 5) { text = 'Fuel Gas'; key = 'fuel-gas'; }
            else { text = 'Catalytic Oxidation'; key = 'catalytic'; }
            textEl.textContent = text + " Configuration";
            const item = document.getElementById(`config-${key}`);
            if (item) item.classList.add('recommended');
        }
        window.toggleDropdown = function() { /* ... Same as before ... */ 
            const btn = document.getElementById('dropdownButton');
            if (btn.disabled) return;
            document.getElementById('dropdownMenu').classList.toggle('open');
            const arrow = document.getElementById('dropdownArrow');
            if (arrow) arrow.classList.toggle('open');
        };

        const tooltip = document.getElementById('tooltip');

        function showTooltip(event, data, type) {
            let content = `<div class="tooltip-title">${data.name || "Details"}</div>`;
            for (let [key, value] of Object.entries(data)) {
                if (key !== 'name') {
                    const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    content += `<div class="tooltip-value"><span class="tooltip-label">${formattedKey}:</span><span class="tooltip-data">${value}</span></div>`;
                }
            }
            const equipmentElement = event.target.closest('.equipment-hover');
            if (type === 'equipment' && equipmentElement && selectedDesignations[equipmentElement.id]) {
                 content += `<div class="tooltip-value"><span class="tooltip-label">Designation:</span><span class="tooltip-data">${selectedDesignations[equipmentElement.id]}</span></div>`;
            }
            tooltip.innerHTML = content;
            tooltip.style.left = event.pageX + 15 + 'px';
            tooltip.style.top = event.pageY + 15 + 'px';
            tooltip.classList.add('visible');
        }
        function hideTooltip() { tooltip.classList.remove('visible'); }

        function addHoverListenersToSVG() {
            const currentSVG = document.getElementById('interactive-sru-diagram-page');
            if (!currentSVG || currentSVG.dataset.listenersAttached === 'true') return;
            currentSVG.querySelectorAll('.equipment-hover').forEach(element => {
                element.addEventListener('mouseenter', (event) => { if (equipmentData[element.id]) showTooltip(event, equipmentData[element.id], 'equipment'); });
                element.addEventListener('mousemove', (event) => { if (tooltip.classList.contains('visible')) { tooltip.style.left = event.pageX + 15 + 'px'; tooltip.style.top = event.pageY + 15 + 'px'; } });
                element.addEventListener('mouseleave', hideTooltip);
            });
            currentSVG.querySelectorAll('.stream-hover').forEach(element => {
                 element.addEventListener('mouseenter', (event) => { if (streamData[element.dataset.stream]) showTooltip(event, streamData[element.dataset.stream], 'stream'); });
                element.addEventListener('mousemove', (event) => { if (tooltip.classList.contains('visible')) { tooltip.style.left = event.pageX + 15 + 'px'; tooltip.style.top = event.pageY + 15 + 'px'; } });
                element.addEventListener('mouseleave', hideTooltip);
            });
            currentSVG.dataset.listenersAttached = 'true';
        }

        window.selectConfig = function(type) {
            const mainGrid = document.getElementById('mainGrid');
            const pageContent = document.getElementById('pageContent');
            const sruDrawingContainer = document.getElementById('sruDrawingContainer');
            const equipmentDesignationSection = document.getElementById('equipmentDesignationSection');

            document.body.className = configurations[type].colorClass;
            mainGrid.style.display = 'none';
            pageContent.style.display = 'block';
            equipmentDesignationSection.style.display = 'block';

            selectedDesignations = {}; // Reset global selections
            const config = configurations[type];

            // Pre-select recommended designations
            if (config.recommendedDesignations) {
                for (const eqId in config.recommendedDesignations) {
                    const recommendedValue = config.recommendedDesignations[eqId];
                    const selectElement = document.getElementById(`select-${eqId}-designation`);
                    if (selectElement) {
                        selectElement.value = recommendedValue;
                        // Add .recommended-designation class to the selected option
                        Array.from(selectElement.options).forEach(opt => {
                            opt.classList.remove('recommended-designation');
                            if (opt.value === recommendedValue) {
                                opt.classList.add('recommended-designation');
                            }
                        });
                    }
                    selectedDesignations[eqId] = recommendedValue; // Update global state
                }
            } else { // Fallback if no recommendations defined for this config type, reset all
                 document.querySelectorAll('.equipment-designation-section select').forEach(sel => {
                    sel.value = "";
                    Array.from(sel.options).forEach(opt => opt.classList.remove('recommended-designation'));
                 });
            }


            document.getElementById('pageTitle').textContent = config.title;
            document.getElementById('pageDescription').textContent = config.description;
            document.getElementById('compositionGrid').innerHTML = `<div class="composition-item"><div class="label">H2S</div><div class="value">${gasComposition.h2s.toFixed(2)}%</div></div> <div class="composition-item"><div class="label">CO2</div><div class="value">${gasComposition.co2.toFixed(2)}%</div></div> <div class="composition-item"><div class="label">NH3</div><div class="value">${gasComposition.nh3.toFixed(2)}%</div></div> <div class="composition-item"><div class="label">BTEX</div><div class="value">${gasComposition.btex.toFixed(2)}%</div></div> <div class="composition-item"><div class="label">Other HC</div><div class="value">${gasComposition.other_hc.toFixed(2)}%</div></div>`;
            
            sruDrawingContainer.innerHTML = sruDrawings[type] || sruDrawings['simple-mixer'];

            const infoGrid = document.getElementById('infoGrid');
            infoGrid.innerHTML = '';
            config.info.forEach(section => { 
                const card = document.createElement('div'); card.className = 'info-card';
                let itemsHtml = section.items.map(item => `<li>${item}</li>`).join('');
                card.innerHTML = `<h3>${section.title}</h3><ul>${itemsHtml}</ul>`;
                infoGrid.appendChild(card);
            });
            if (gasComposition.nh3 > 0 || gasComposition.btex > 0 || gasComposition.other_hc > 0) { 
                 const specialCard = document.createElement('div'); specialCard.className = 'info-card';
                let specialItems = [];
                if (gasComposition.nh3 > 0) specialItems.push('NH3 destruction requires higher temperature');
                if (gasComposition.btex > 0) specialItems.push('BTEX destruction at elevated temperatures');
                if (gasComposition.other_hc > 0) specialItems.push('Hydrocarbon combustion considerations');
                specialCard.innerHTML = `<h3>Special Considerations</h3><ul>${specialItems.map(i=>`<li>${i}</li>`).join('')}</ul>`;
                infoGrid.appendChild(specialCard);
            }

            const menu = document.getElementById('dropdownMenu');
            if (menu.classList.contains('open')) toggleDropdown();
            
            const diagram = document.getElementById('interactive-sru-diagram-page');
            if (diagram) diagram.dataset.listenersAttached = 'false';
            setTimeout(addHoverListenersToSVG, 50); 
        };

        window.goBack = function() { 
            document.body.className = '';
            document.getElementById('mainGrid').style.display = 'grid';
            document.getElementById('pageContent').style.display = 'none';
            document.getElementById('equipmentDesignationSection').style.display = 'none';
            const diagram = document.getElementById('interactive-sru-diagram-page');
            if (diagram) diagram.dataset.listenersAttached = 'false';
        };
        document.addEventListener('click', function(event) { 
            const container = document.querySelector('.dropdown-container');
            const btn = document.getElementById('dropdownButton');
            const menu = document.getElementById('dropdownMenu');
            if (container && !container.contains(event.target) && event.target !== btn && menu.classList.contains('open')) {
                toggleDropdown();
            }
        });
        document.addEventListener('DOMContentLoaded', function() {
            ['h2s', 'co2', 'nh3', 'btex', 'other_hc'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateTotal);
            });
            updateTotal();

            document.querySelectorAll('.equipment-designation-section select').forEach(selectElement => {
                selectElement.addEventListener('change', function(event) {
                    const equipmentId = event.target.dataset.equipmentId;
                    if (equipmentId) {
                        selectedDesignations[equipmentId] = event.target.value;
                        // Remove .recommended-designation from all options in this select
                        Array.from(event.target.options).forEach(opt => opt.classList.remove('recommended-designation'));
                        // Add .recommended-designation to the newly selected option
                        if (event.target.selectedOptions.length > 0) {
                            event.target.selectedOptions[0].classList.add('recommended-designation');
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
